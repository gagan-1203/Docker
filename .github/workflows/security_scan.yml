name: Security Scan - Grype (SCA)

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  grype_scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read     # Allows checkout to read repository content
      security-events: write # Allows upload-sarif to write results to Code Scanning
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Scan Project for Vulnerabilities (Generate SARIF)
        uses: anchore/scan-action@v3 
        id: scan
        with:
          path: .
          fail-build: true
          # FIXED: Set cutoff to 'high' to catch High and Critical
          severity-cutoff: high 
          # FIXED: Output in SARIF format for the next step
          output-format: sarif
          # NOTE: The old 'upload-sarif: true' is removed entirely
          
      - name: Upload SARIF results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          # Use the SARIF file generated by the previous step
          sarif_file: ${{ steps.scan.outputs.sarif }}
        
      - name: Generate SBOM (for artifact storage/auditing)
        uses: anchore/sbom-action@v0
        if: always() 
        with:
          format: cyclonedx-json
          output-file: sbom.json
#To display the human-readable summary
      - name: Display SBOM Summary (Human Readable)
        if: always() # Runs even if the scan failed, so developers see the inventory
        run: |
          echo "--- Starting SBOM Summary Generation ---"
          
          # 1. Install Syft CLI temporarily in this run step's environment
          # We use the same install command we ran locally in WSL
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          
          # 2. Use the Syft CLI to convert the generated JSON back into a table
          /usr/local/bin/syft convert ./sbom.json -o syft-table

          echo "--- SBOM Summary Complete ---"
